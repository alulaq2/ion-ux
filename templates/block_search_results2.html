<div id="searchResultsTabContainer" style="position:relative; height:28px; width:100%;">
	<div class="twoNavTabs" style="left:24px;width:calc(100% - 24px);">
		<div id="dataSearchResultsTab" class="twoNavTab active" tabContent="#dataSearchResultsAccordion">Data</div>
		<div id="assetsSearchResultsTab" class="twoNavTab" tabContent="#assetsSearchResultsAccordion">Assets</div>
		<div id="sitesSearchResultsTab" class="twoNavTab" tabContent="#siteSearchResultsAccordion">Sites</div>
	</div>
</div>
<div id="searchResultsContainer" >
	<div id="dataSearchResultsAccordion"> 
		<div class="accordionContainerWhite">
		</div>
	</div>
	<div id="assetsSearchResultsAccordion" style="display:none;">
		<div class="accordionContainerWhite">
		</div>	
	</div>
	<div id="siteSearchResultsAccordion" style="display:none;">
		<div class="accordionContainerWhite">
		</div>	
	</div>
</div>

<script id="TABLE_searchResults">

	var TABLE_searchResults=[
		["text_short_ooi", "Name", "name", "T05", "0", "level-zero"], 
		["text_extended_ooi", "Description", "description", "T09", "0", "level-zero"], 
		["text_short_ooi", "Created", "ts_created", "T10", "2", "level-two"], 
		["text_short_ooi", "Modified", "ts_updated", "T11", "0", "level-zero"], 
		["text_short_ooi", "Lifecycle State", "lcstate", "T13", "0", "level-zero"]
	];

</script>

<script>
	$(function () {
		$('#searchResultsContainer').jScrollPane({autoReinitialise: true});

		IONUX2.parseSearchResults = function(response_data) {
			var assetsList = {};
			_.each(response_data, function(resource) {
				_.each(assetTypesList, function(resourceType) {
					if (resource['type_'] == resourceType.type){
						if (!(resourceType.type in assetsList)){
							assetsList[resourceType.type] = [];
						}
						assetsList[resourceType.type].push(resource);
					}
				});
			});
			console.log(response_data);
			console.log('ASSETS!!!!');
			console.log(assetsList);

			_.each(assetTypesList, function(resourceType) {
				var accordion_contents = "#accordion" + resourceType.id;
				var accordion = $(accordion_contents).closest('.accordionWhite');
				var table_elem = '#table' + resourceType.id;
				var table_data = assetsList[resourceType.type];
				console.log(table_data);
				if(resourceType.type in assetsList){
					new IONUX.Views.DataTable({el: table_elem, data: table_data, visibility_level:2});
					accordion.show();
				} else {
					accordion.hide();
				}
			});
			
			var sitesList = {};
			_.each(response_data, function(resource) {
				_.each(siteTypesList, function(resourceType) {
					if (resource['type_'] == resourceType.type){
						if (!(resourceType.type in sitesList)){
							sitesList[resourceType.type] = [];
						}
						sitesList[resourceType.type].push(resource);
					}
				});
			});
			console.log('SITES!!!!');
			console.log(sitesList);

			_.each(siteTypesList, function(resourceType) {
				var accordion_contents = "#accordion" + resourceType.id;
				var accordion = $(accordion_contents).closest('.accordionWhite');
				var table_elem = '#table' + resourceType.id;
				var table_data = sitesList[resourceType.type];
				console.log(table_data);
				if(resourceType.type in sitesList){
					new IONUX.Views.DataTable({el: table_elem, data: table_data, visibility_level:2});
					accordion.show();
				} else {
					accordion.hide();
				}
			});
		}

		var dataTypesList = [
			{'name':"Conductivity", 'id':"Conductivity"},
			{'name':"Density", 'id':"Density"},
			{'name':"Fluorometric CDOM Concentration", 'id':"CDOM"},
			{'name':"Fluorometric Chlorophyll-a Concentration", 'id':"Chlorophyll"},
			{'name':"Optical Absorbance Signal Intensity at 578nm", 'id':"Absorbance"},
			{'name':"Optical Backscatter (Red Wavelengths)", 'id':"Backscatter"},
			{'name':"Oxygen Concentration from Stable DO Instrument", 'id':"Oxygen"},
			{'name':"PHSEN Thermistor Temperature", 'id':"Thermistor"},
			{'name':"Practical Salinity", 'id':"Salinity"},
			{'name':"Pressure (Depth)", 'id':"Depth"},
			{'name':"Temperature", 'id':"Temperature"},
			{'name':"Velocity Profile", 'id':"Velocity"},
			{'name':"pH",'id':"PH"}
		];

		var assetTypesList = [
			{'name':"Platform", 'id':"Platform", 'type':"Platform"},
			{'name':"Instrument", 'id':"Instrument", 'type':"Instrument"}
		];

		var siteTypesList = [
			{'name':"Facility", 'id':"Facility", 'type':"Org"},
			{'name':"Observatory", 'id':"Observatory", 'type':"Observatory"},
			{'name':"Station", 'id':"StationSite", 'type':"StationSite"},
			{'name':"Platform Site", 'id':"PlatformSite", 'type':"PlatformSite"},
			{'name':"Instrument Site", 'id':"InstrumentSite", 'type':"InstrumentSite"}
		];

		var tableScriptTemplate = 'var TABLE_table<%= id %> = TABLE_searchResults;';

		var accordionWhiteTemplate = '<div class="accordionWhite collapsed"> <div class="accordionWhiteLabel"> <%= name %> <div class="expandHide arrowRight blue"></div> </div> <div class="accordionWhitePin"></div> <div class="accordionContents" style="display:none;" id="accordion<%= id %>"> <div id="table<%= id %>"> </div> </div> </div>';

		_.each(dataTypesList, function(type) {
			var script=document.createElement('script');
			script.id='TABLE_table' + type.id;
			script.text=_.template(tableScriptTemplate, type);
			$("#searchResultsTabContainer").parent().append(script);
			var blah = $(_.template(accordionWhiteTemplate, type));
		    $('#dataSearchResultsAccordion').children('.accordionContainerWhite').append(blah);
		});

		_.each(assetTypesList, function(type) {
			var script=document.createElement('script');
			script.id='TABLE_table' + type.id;
			script.text=_.template(tableScriptTemplate, type);
			$("#searchResultsTabContainer").parent().append(script);
			var blah = $(_.template(accordionWhiteTemplate, type));
		    $('#assetsSearchResultsAccordion').children('.accordionContainerWhite').append(blah);
		});

		_.each(siteTypesList, function(type) {
			var script=document.createElement('script');
			script.id='TABLE_table' + type.id;
			script.text=_.template(tableScriptTemplate, type);
			$("#searchResultsTabContainer").parent().append(script);
			var blah = $(_.template(accordionWhiteTemplate, type));
		    $('#siteSearchResultsAccordion').children('.accordionContainerWhite').append(blah);
		});

		$("#searchResultsTabContainer .twoNavTab").click(function(e){
			var target = $(e.target);
			target.addClass('active').siblings().removeClass('active');
			tab_content = target.attr("tabContent");
			$(tab_content).siblings().hide();
			$(tab_content).show();
		});

        $('.accordionContainerWhite').sortable({
        	items: ".accordionWhite:not(.pinned)"
        });

        function toggleAccordion(accordion_contents){
			accordion_contents.slideToggle('fast', function() {
				if ($(this).is(':visible')) {
					$(this).parent().removeClass('collapsed');
					$(this).parent().find('.expandHide').removeClass('arrowRight');
					$(this).parent().find('.expandHide').addClass('arrowDown');
				} else {
					$(this).parent().addClass('collapsed');
					$(this).parent().find('.expandHide').removeClass('arrowDown');
					$(this).parent().find('.expandHide').addClass('arrowRight');
				}
			});
        }

        $('.accordionWhitePin').click(function(e){
        	e.preventDefault();
        	var pin = $(e.currentTarget);
        	var accordion = pin.closest('.accordionWhite');
        	if(!accordion.hasClass('pinned')) {
        		/*if(accordion.hasClass('collapsed')){
        			toggleAccordion( accordion.find('.accordionContents'));
        		}*/
        		accordion.addClass('pinned');
        	} else {
        		/*if(!accordion.hasClass('collapsed')){
        			toggleAccordion( accordion.find('.accordionContents'));
        		}*/
        		accordion.removeClass('pinned');
        	}
	        $( ".accordionContainerWhite" ).sortable( "disable" );
	        $('.accordionContainerWhite').sortable({
	        	items: ".accordionWhite:not(.pinned)"
	        });
	        $( ".accordionContainerWhite" ).sortable( "enable" );
        });

		$('.accordionWhiteLabel').click(function(e){
			e.preventDefault();
			var link = $(e.currentTarget);
			var accordion = link.closest('.accordionWhite');
			if( !accordion.hasClass('pinned')){
				// this code would collapse other non-pinned accordions
				// when you open one, but we don't do that anymore.
				/* if( accordion.hasClass('collapsed')){
					toggleAccordion( accordion.siblings('.accordionWhite:not(.pinned)').find('.accordionContents:visible'));
				} */
				toggleAccordion( accordion.find('.accordionContents'));
			}
		});

	})
</script>
